{% extends "base.html" %}
{% load static %}

{% block title %}Audit Log Entry - {{ log.id }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Breadcrumbs -->
    <nav class="mb-6">
        <ol class="flex items-center space-x-2 text-sm text-gray-500">
            <li><a href="{% url 'core:dashboard' %}" class="hover:text-blue-600">Dashboard</a></li>
            <li>/</li>
            <li><a href="{% url 'audit:log_list' %}" class="hover:text-blue-600">Audit Log</a></li>
            <li>/</li>
            <li>Entry #{{ log.id }}</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Audit Log Entry</h1>
            <p class="mt-1 text-sm text-gray-600">Detailed information about this audit event</p>
        </div>
        <div class="flex items-center space-x-3">
            {% if log.has_next %}
            <a href="{% url 'audit:log_detail' log.get_next.pk %}"
               class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                Next
            </a>
            {% endif %}
            {% if log.has_previous %}
            <a href="{% url 'audit:log_detail' log.get_previous.pk %}"
               class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Previous
            </a>
            {% endif %}
            <a href="{% url 'audit:log_list' %}"
               class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                </svg>
                Back to List
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Basic Information -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-medium text-gray-900">Event Details</h2>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                 {% if log.action == 'CREATE' %}bg-green-100 text-green-800
                                 {% elif log.action == 'UPDATE' %}bg-blue-100 text-blue-800
                                 {% elif log.action == 'DELETE' %}bg-red-100 text-red-800
                                 {% elif log.action == 'LOGIN' %}bg-purple-100 text-purple-800
                                 {% elif log.action == 'LOGOUT' %}bg-gray-100 text-gray-800
                                 {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                        {{ log.get_action_display }}
                    </span>
                </div>

                <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Timestamp</dt>
                        <dd class="mt-1 text-sm text-gray-900">
                            {{ log.timestamp|date:"F d, Y \a\t g:i A" }}
                            <span class="text-gray-500">({{ log.timestamp|timesince }} ago)</span>
                        </dd>
                    </div>

                    <div>
                        <dt class="text-sm font-medium text-gray-500">Content Type</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ log.content_type.model|title }}</dd>
                    </div>

                    {% if log.object_id %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Object ID</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ log.object_id }}</dd>
                    </div>
                    {% endif %}

                    {% if log.object_repr %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Object</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ log.object_repr }}</dd>
                    </div>
                    {% endif %}

                    <div>
                        <dt class="text-sm font-medium text-gray-500">IP Address</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ log.ip_address|default:"Unknown" }}</dd>
                    </div>

                    {% if log.user_agent %}
                    <div class="md:col-span-2">
                        <dt class="text-sm font-medium text-gray-500">User Agent</dt>
                        <dd class="mt-1 text-sm text-gray-900 break-all">{{ log.user_agent }}</dd>
                    </div>
                    {% endif %}
                </dl>
            </div>

            <!-- Changes/Data -->
            {% if log.changes or log.additional_data %}
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">
                    {% if log.action == 'UPDATE' %}Changes Made{% else %}Event Data{% endif %}
                </h2>

                {% if log.changes %}
                <div class="space-y-4">
                    {% for field, change in log.changes.items %}
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h3 class="text-sm font-medium text-gray-900 mb-2">{{ field|title }}</h3>

                        {% if log.action == 'UPDATE' %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="text-xs font-medium text-gray-500 uppercase mb-1">Previous Value</h4>
                                <div class="bg-red-50 border border-red-200 rounded p-3">
                                    <pre class="text-sm text-gray-900 whitespace-pre-wrap">{{ change.0|default:"(empty)" }}</pre>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-xs font-medium text-gray-500 uppercase mb-1">New Value</h4>
                                <div class="bg-green-50 border border-green-200 rounded p-3">
                                    <pre class="text-sm text-gray-900 whitespace-pre-wrap">{{ change.1|default:"(empty)" }}</pre>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="bg-gray-50 border border-gray-200 rounded p-3">
                            <pre class="text-sm text-gray-900 whitespace-pre-wrap">{{ change|default:"(empty)" }}</pre>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if log.additional_data %}
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <h3 class="text-sm font-medium text-gray-900 mb-2">Additional Data</h3>
                    <div class="bg-gray-50 border border-gray-200 rounded p-3">
                        <pre class="text-sm text-gray-900 whitespace-pre-wrap">{{ log.additional_data|pprint }}</pre>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Related Objects -->
            {% if related_logs %}
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Related Events</h2>
                <div class="space-y-3">
                    {% for related_log in related_logs %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                         {% if related_log.action == 'CREATE' %}bg-green-100 text-green-800
                                         {% elif related_log.action == 'UPDATE' %}bg-blue-100 text-blue-800
                                         {% elif related_log.action == 'DELETE' %}bg-red-100 text-red-800
                                         {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ related_log.get_action_display }}
                            </span>
                            <div>
                                <p class="text-sm font-medium text-gray-900">{{ related_log.content_type.model|title }}</p>
                                <p class="text-xs text-gray-500">{{ related_log.timestamp|timesince }} ago</p>
                            </div>
                        </div>
                        <a href="{% url 'audit:log_detail' related_log.pk %}"
                           class="text-sm text-blue-600 hover:text-blue-800">
                            View →
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- User Information -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">User Information</h3>

                <div class="flex items-center space-x-3 mb-4">
                    {% if log.user.avatar %}
                        <img class="h-10 w-10 rounded-full" src="{{ log.user.avatar.url }}" alt="">
                    {% else %}
                        <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                            <span class="text-sm font-medium text-gray-600">
                                {{ log.user.get_full_name|default:log.user.username|first|upper }}
                            </span>
                        </div>
                    {% endif %}
                    <div>
                        <p class="text-sm font-medium text-gray-900">
                            {{ log.user.get_full_name|default:log.user.username }}
                        </p>
                        <p class="text-xs text-gray-500">{{ log.user.email }}</p>
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Role</span>
                        <span class="text-gray-900">
                            {% if log.user.is_staff %}Staff{% else %}Customer{% endif %}
                        </span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Member Since</span>
                        <span class="text-gray-900">{{ log.user.date_joined|date:"M Y" }}</span>
                    </div>
                    {% if log.user.last_login %}
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Last Login</span>
                        <span class="text-gray-900">{{ log.user.last_login|timesince }} ago</span>
                    </div>
                    {% endif %}
                </div>

                <div class="mt-4 pt-4 border-t border-gray-200">
                    <a href="{% url 'accounts:detail' log.user.pk %}"
                       class="text-sm text-blue-600 hover:text-blue-800">
                        View User Profile →
                    </a>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">User Activity</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Total Actions</span>
                        <span class="text-sm font-semibold text-gray-900">{{ user_stats.total_actions }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">This Month</span>
                        <span class="text-sm font-semibold text-gray-900">{{ user_stats.month_actions }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">This Week</span>
                        <span class="text-sm font-semibold text-gray-900">{{ user_stats.week_actions }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Today</span>
                        <span class="text-sm font-semibold text-gray-900">{{ user_stats.today_actions }}</span>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-200">
                    <a href="{% url 'audit:user_history' log.user.pk %}"
                       class="text-sm text-blue-600 hover:text-blue-800">
                        View All User Activity →
                    </a>
                </div>
            </div>

            <!-- Actions -->
            {% if request.user.is_staff %}
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Actions</h3>
                <div class="space-y-2">
                    {% if log.action == 'UPDATE' and log.can_revert %}
                    <button hx-post="{% url 'audit:revert_change' log.pk %}"
                            hx-confirm="Are you sure you want to revert this change? This action cannot be undone."
                            class="block w-full text-left px-3 py-2 text-sm text-orange-700 hover:bg-orange-50 rounded-md">
                        Revert Change
                    </button>
                    {% endif %}

                    <button hx-post="{% url 'audit:flag_entry' log.pk %}"
                            class="block w-full text-left px-3 py-2 text-sm text-yellow-700 hover:bg-yellow-50 rounded-md">
                        {% if log.is_flagged %}Unflag Entry{% else %}Flag for Review{% endif %}
                    </button>

                    <button hx-get="{% url 'audit:export_entry' log.pk %}"
                            hx-target="#export-modal"
                            hx-swap="innerHTML"
                            class="block w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-md">
                        Export Entry
                    </button>

                    {% if log.content_object %}
                    <a href="{{ log.content_object.get_absolute_url }}"
                       class="block w-full text-left px-3 py-2 text-sm text-blue-700 hover:bg-blue-50 rounded-md">
                        View Related Object
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Technical Details -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Technical Details</h3>
                <div class="space-y-2 text-sm">
                    <div>
                        <span class="text-gray-500">Entry ID:</span>
                        <span class="text-gray-900 font-mono">{{ log.pk }}</span>
                    </div>
                    <div>
                        <span class="text-gray-500">Session ID:</span>
                        <span class="text-gray-900 font-mono">{{ log.session_key|default:"N/A" }}</span>
                    </div>
                    {% if log.request_id %}
                    <div>
                        <span class="text-gray-500">Request ID:</span>
                        <span class="text-gray-900 font-mono">{{ log.request_id }}</span>
                    </div>
                    {% endif %}
                    <div>
                        <span class="text-gray-500">Checksum:</span>
                        <span class="text-gray-900 font-mono text-xs">{{ log.checksum|default:"N/A" }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div id="export-modal"></div>

<script>
// Handle action responses
document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.successful) {
        // Show success notification
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
        notification.textContent = 'Action completed successfully';
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
});
</script>
{% endblock %}